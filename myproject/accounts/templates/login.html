<style type="text/css">
    .tg  {border:none;border-collapse:collapse;border-color:#9ABAD9;border-spacing:0;margin:0px auto;}
    .tg td{background-color:#EBF5FF;border-color:#9ABAD9;border-style:solid;border-width:0px;color:#444;
      font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}
    .tg th{background-color:#409cff;border-color:#9ABAD9;border-style:solid;border-width:0px;color:#fff;
      font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
    .tg .tg-2b7s{text-align:right;vertical-align:bottom}
    .tg .tg-1wig{font-weight:bold;text-align:left;vertical-align:top}
    .tg .tg-snd4{background-color:#D2E4FC;text-align:right;vertical-align:bottom}
    .tg .tg-yhvy{background-color:#D2E4FC;font-family:Arial, Helvetica, sans-serif !important;font-weight:bold;text-align:left;
      vertical-align:bottom}
    .tg .tg-hmp3{background-color:#D2E4FC;text-align:left;vertical-align:top}
    .tg .tg-7dnc{background-color:#D2E4FC;font-weight:bold;text-align:left;vertical-align:top}
    .tg .tg-5kdf{color:#000000;font-family:Impact, Charcoal, sans-serif !important;font-size:36px;position:-webkit-sticky;
      position:sticky;text-align:center;top:-1px;vertical-align:top;will-change:transform}
    .tg .tg-wn3b{background-color:#D2E4FC;text-align:center;vertical-align:middle}
    .tg .tg-bhuq{background-color:#D2E4FC;font-weight:bold;text-align:left;vertical-align:bottom}
    .tg .tg-j0tj{background-color:#D2E4FC;text-align:center;vertical-align:top}
    .tg .tg-0lax{text-align:left;vertical-align:top}
    .tg .tg-g3ys{background-color:#D2E4FC;font-weight:bold;text-align:center;vertical-align:bottom}
    .tg .tg-7zrl{text-align:left;vertical-align:bottom}
    .tg .tg-nrix{text-align:center;vertical-align:middle}
    .tg .tg-f0ep{background-color:#D2E4FC;text-align:left;vertical-align:bottom}
    .tg-sort-header::-moz-selection{background:0 0}
    .tg-sort-header::selection{background:0 0}.tg-sort-header{cursor:pointer}
    .tg-sort-header:after{content:'';float:right;margin-top:7px;border-width:0 5px 5px;border-style:solid;
      border-color:#404040 transparent;visibility:hidden}
    .tg-sort-header:hover:after{visibility:visible}
    .tg-sort-asc:after,.tg-sort-asc:hover:after,.tg-sort-desc:after{visibility:visible;opacity:.4}
    .tg-sort-desc:after{border-bottom:none;border-width:5px 5px 0}@media screen and (max-width: 767px) {.tg {width: auto !important;}.tg col {width: auto !important;}.tg-wrap {overflow-x: auto;-webkit-overflow-scrolling: touch;margin: auto 0px;}}</style>
    <div class="tg-wrap"><table id="tg-LZvK3" class="tg"><thead>
      <tr>
        <th class="tg-5kdf" colspan="6"><span style="font-weight:bold">Philhealth Review</span></th>
      </tr></thead>
    <tbody>
      <tr>
        <td class="tg-yhvy" style="white-space: nowrap;"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Company</span></td>
        <td class="tg-7dnc" style="white-space: nowrap;">
            <select id="companyDropdown" style="font-weight:700;font-style:normal;text-decoration:none;color:#000">
                <option value="">Select a company</option>
            </select>
        </td>
        </td>
        <td class="tg-hmp3"></td>
        <td class="tg-7dnc" style="text-align: right;">Filter</td>
        <td class="tg-bhuq" style="text-align: left;">
            <select id="filter-dropdown" style="font-weight:700;font-style:normal;text-decoration:none;color:#000" onchange="filterRows(this.value)">
                <option value="All">All</option>
                <option value="Matched">Matched</option>
                <option value="Unmatched">Unmatched</option>
            </select>
          </div>
          <!-- 
          <div style="text-align: middle;">
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)" style="display: none;" />
            <button id="select-file-button" onclick="document.getElementById('fileInput').click();">Select File</button>
            <div id="fileContentDisplay"></div>
          </div>
          -->
          <td class="tg-j0tj">
            <a href="#" id="exportExcel">
                <img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3cpath fill='%23000000' d='M504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-143.6-28.9L288 302.6V120c0-13.3-10.7-24-24-24h-16c-13.3 0-24 10.7-24 24v182.6l-72.4-75.5c-9.3-9.7-24.8-9.9-34.3-.4l-10.9 11c-9.4 9.4-9.4 24.6 0 33.9L239 404.3c9.4 9.4 24.6 9.4 33.9 0l132.7-132.7c9.4-9.4 9.4-24.6 0-33.9l-10.9-11c-9.5-9.5-25-9.3-34.3.4z'/%3e%3c/svg%3e" alt="Image" width="18" height="18" onclick="generateExcel()">
                <script>
                    function generateExcel() {
                        var table = document.getElementById('tg-LZvK3');
                        var html = table.outerHTML;
                        var url = 'data:application/vnd.ms-excel,' + escape(html); // Set your file format
                        var link = document.getElementById('exportExcel');
                        link.setAttribute('href', url);
                        link.setAttribute('download', 'exported_table.xls'); // Set your file name
                    }
                </script>
            </a>
        </td>
      </tr>
      <tr>
        <td class="tg-1wig"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Period</span></td>
        <td class="tg-1wig">
            <select id="periodDropdown" style="font-weight:700;font-style:normal;text-decoration:none;color:#000">
                <option value="">Select a period</option>
            </select>
        </td>
        <td class="tg-0lax"></td>
        <td class="tg-0lax"></td>
        <td class="tg-0lax"></td>
        <td class="tg-0lax"></td>
      </tr>
      <tr>
        <td class="tg-yhvy"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">PHIC</span> <span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Rate</span></td>
        <td class="tg-bhuq">
            <select id="phicRateDropdown" style="font-weight:700;font-style:normal;text-decoration:none;color:#000">
                <option value="3%">3%</option>
                <option value="3.5%">3.5%</option>
                <option value="4%">4%</option>
                <option value="4.5%">4.5%</option>
                <option value="5%" selected>5%</option>
            </select>
        </td>
        <td class="tg-hmp3"></td>
        <td class="tg-hmp3"></td>
        <td class="tg-hmp3"></td>
        <td class="tg-hmp3"></td>
      </tr>
      <tr>
        <td class="tg-0lax" colspan="6"></td>
      </tr>
      <tr class="employee-header">
        <td class="main-header"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Chapa</span>
        <td class="main-header"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Employee</span> <span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Name</span></td>
        <td class="main-header"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Basic</span> <span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Pay</span></td>
        <td class="main-header"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">System</span> <span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Amount</span></td>
        <td class="main-header"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">PHIC</span> <span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Amount</span></td>
        <td class="main-header"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000">Remarks</span></td>
      </tr> 
      <tr class="employee-data">
    </tr>
    </table></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            calc();

            var filterDropdown = document.getElementById('filter-dropdown');
            filterDropdown.addEventListener('change', function() {
                var selectedOption = filterDropdown.value;
                var remarksCells = document.querySelectorAll('.remarks');

                remarksCells.forEach(function(cell) {
                    var row = cell.parentElement;
                    var isHeaderRow = row.classList.contains('main-header');

                    if (!isHeaderRow) {
                        if (selectedOption === 'All' || cell.textContent === selectedOption) {
                            row.style.display = 'table-row';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        });

        function calc() {
            var rows = document.querySelectorAll('.phic-amount');
            var phicRate = 0.025;

            rows.forEach(function(row) {
                var basicPayCell = row.previousElementSibling.previousElementSibling.querySelector('.basic-pay span');
                if (basicPayCell !== null) {
                    var basicPay = parseFloat(basicPayCell.innerText.replace(/,/g, ''));
                    var phicAmount = basicPay * phicRate;
                    var phicAmountCell = row;
                    phicAmountCell.textContent = phicAmount.toFixed(2);

                    var systemAmountCell = row.previousElementSibling.querySelector('.system-amount span');
                    var remarksCell = row.nextElementSibling;

                    if (systemAmountCell !== null && remarksCell !== null) {
                        var systemAmount = parseFloat(systemAmountCell.innerText.replace(/,/g, ''));
                        console.log(`System Amount: ${systemAmount}, PHIC Amount: ${phicAmount}`);
                        if (systemAmount.toFixed(2) === phicAmount.toFixed(2)) {
                            remarksCell.textContent = 'Matched';
                        } else {
                            remarksCell.textContent = 'Unmatched';
                        }
                    }
                }
            });
        }

        let temporaryFileContent = '';

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    temporaryFileContent = e.target.result;
                    displayFileContent();
                };
                reader.readAsText(file);
            }
        }

        function displayFileContent() {
            const lines = temporaryFileContent.split('\n');
            const headers = lines[0].split(',');

            const tableRows = document.querySelectorAll('.employee-header + tr');

            for (let i = 1; i < lines.length; i++) {
                const data = lines[i].split(',');
                let row;

                if (i - 1 < tableRows.length) {
                    row = tableRows[i - 1];
                } else {
                    row = document.createElement('tr');
                    // Create and append cells for each header
                    headers.forEach((header) => {
                        const cell = document.createElement('td');
                        row.appendChild(cell);
                    });
                    document.querySelector('table').appendChild(row);
                }

                const cells = row.querySelectorAll('td');

                cells[0].textContent = data[0] || ''; // Employee ID
                cells[1].textContent = data[1] || ''; // Employee Name
                cells[2].textContent = data[2] || ''; // Basic Pay
                cells[3].textContent = data[3] || ''; // System Amount

                const systemAmountCell = cells[3];
                const phicAmountCell = cells[4] || document.createElement('td');
                const remarksCell = cells[5] || document.createElement('td');

                if (!row.contains(phicAmountCell)) {
                    row.appendChild(phicAmountCell);
                }
                if (!row.contains(remarksCell)) {
                    row.appendChild(remarksCell);
                }

                if (systemAmountCell && phicAmountCell && remarksCell) {
                    const systemAmount = parseFloat(systemAmountCell.innerText.replace(/,/g, '') || 0);
                    const basicPay = parseFloat(data[2].replace(/,/g, '') || 0);
                    const phicRate = 0.025;
                    const calculatedPhicAmount = basicPay * phicRate;

                    phicAmountCell.textContent = calculatedPhicAmount.toFixed(2);

                    const phicAmount = parseFloat(phicAmountCell.innerText.replace(/,/g, '') || 0);

                    if (!isNaN(systemAmount) && !isNaN(phicAmount)) {
                        if (systemAmount.toFixed(2) === phicAmount.toFixed(2)) {
                            remarksCell.textContent = 'Matched';
                        } else {
                            remarksCell.textContent = 'Unmatched';
                        }
                    }
                }
            }
        }

        function filterRows(filterValue) {
            const tableRows = document.querySelectorAll('.employee-header + tr');

            tableRows.forEach((row) => {
                const remarksCell = row.querySelector('td:nth-child(6)');
                if (remarksCell) {
                    if (filterValue === 'All' || remarksCell.textContent === filterValue) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Fetch data from the API endpoint
        fetch('https://delmontepayroll.com/citizendev/get-companies/')
            .then(response => response.json())
            .then(data => {
                const companyDropdown = document.getElementById('companyDropdown');

                data.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.text = company.name;
                    companyDropdown.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching data:', error));

        // Function to fetch and populate periods based on the selected company
        function populatePeriods(selectedCompanyId) {
            const periodDropdown = document.getElementById('periodDropdown');
            
            // Fetch data from the API endpoint for the selected company
            fetch(`https://delmontepayroll.com/citizendev/get-payroll-periods/${selectedCompanyId}`)
                .then(response => response.json())
                .then(data => {
                    // Clear existing options
                    periodDropdown.innerHTML = '';

                    // Populate period options
                    data.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period.id;
                        option.text = period.name;
                        periodDropdown.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Event listener for company dropdown change
        const companyDropdown = document.getElementById('companyDropdown');
        companyDropdown.addEventListener('change', function() {
            const selectedCompanyId = this.value;
            populatePeriods(selectedCompanyId);
        });

        // Function to fetch and populate payroll records based on selected company and period
        function fetchPayrollRecords(companyId, payrollPeriodId) {
            const tableBody = document.querySelector('#tg-LZvK3 tbody'); // Assuming your table has a tbody
            const headerRow = document.querySelector('.employee-header'); // Get the header row

            // Fetch payroll records from the API
            fetch(`https://delmontepayroll.com/citizendev/get-payroll-records/${companyId}/${payrollPeriodId}/`)
                .then(response => response.json())
                .then(data => {
                    // Clear existing rows below the header
                    const rowsToRemove = tableBody.querySelectorAll('tr.employee-data');
                    rowsToRemove.forEach(row => row.remove());

                    // Populate the table with new data
                    data.forEach(record => {
                        const row = document.createElement('tr');
                        row.classList.add('employee-data'); // Add the employee-data class

                        // Create cells for each field in the record
                        const employeeIdCell = document.createElement('td');
                        employeeIdCell.textContent = record.employee_id || ''; // Handle null values
                        row.appendChild(employeeIdCell);

                        const employeeNameCell = document.createElement('td');
                        employeeNameCell.textContent = record.employee || '';
                        row.appendChild(employeeNameCell);

                        const basicPayCell = document.createElement('td');
                        const basicPay = parseFloat(record.basic_pay).toFixed(2); // Format to 2 decimal places
                        basicPayCell.textContent = basicPay; 
                        row.appendChild(basicPayCell);

                        const systemAmountCell = document.createElement('td');
                        const systemAmount = parseFloat(record.philhealth).toFixed(2); // Assuming this is the system amount
                        systemAmountCell.textContent = isNaN(systemAmount) || systemAmount === 'NaN' ? '0.00' : systemAmount; 
                        row.appendChild(systemAmountCell);

                        const phicAmountCell = document.createElement('td');
                        phicAmountCell.classList.add('phic-amount'); // Add class for easy access later
                        row.appendChild(phicAmountCell);

                        const remarksCell = document.createElement('td');
                        remarksCell.classList.add('remarks'); // Add class for easy access later
                        row.appendChild(remarksCell);

                        // Insert the new row directly after the employee-header row
                        tableBody.insertBefore(row, headerRow.nextSibling);
                    });

                    // Recalculate PHIC Amounts after populating the table
                    recalculatePhicAmounts();
                })
                .catch(error => console.error('Error fetching payroll records:', error));
        }

        // Function to recalculate PHIC Amounts based on the selected PHIC Rate
        function recalculatePhicAmounts() {
            const phicRateDropdown = document.getElementById('phicRateDropdown'); // Replace with your actual dropdown ID
            const selectedPhicRate = parseFloat(phicRateDropdown.value) / 100; // Convert percentage to decimal

            const rows = document.querySelectorAll('tr.employee-data');
            rows.forEach(row => {
                const basicPayCell = row.querySelector('td:nth-child(3)'); // Basic Pay cell
                const phicAmountCell = row.querySelector('.phic-amount'); // PHIC Amount cell
                const remarksCell = row.querySelector('.remarks'); // Remarks cell

                let basicPay = parseFloat(basicPayCell.textContent.replace(/,/g, '') || 0);
                
                let phicAmount = 0; // Default PHIC Amount

                // Determine PHIC Amount based on Basic Pay
                if (basicPay === 0) {
                    phicAmount = 0; // If Basic Pay is 0
                } else if (basicPay > 0 && basicPay <= 10000) {
                    phicAmount = 250; // Minimum Computation
                } else if (basicPay > 100000) {
                    phicAmount = (100000 * selectedPhicRate) / 2; // Maximum Computation
                } else {
                    phicAmount = (basicPay * selectedPhicRate) / 2; // Normal Computation
                }

                phicAmountCell.textContent = phicAmount.toFixed(2); // Set calculated PHIC Amount

                // Set Remarks based on comparison
                const systemAmount = parseFloat(row.querySelector('td:nth-child(4)').textContent.replace(/,/g, '') || 0);
                const variance = Math.abs(systemAmount - phicAmount);

                if (variance <= 0.01) {
                    remarksCell.textContent = 'Matched';
                    remarksCell.style.color = ''; // Reset color to default
                } else {
                    remarksCell.textContent = 'Unmatched';
                    remarksCell.style.color = 'red'; // Change font color to red
                }
            });
        }

        // Event listener for PHIC Rate dropdown change
        const phicRateDropdown = document.getElementById('phicRateDropdown');
        phicRateDropdown.addEventListener('change', function() {
            recalculatePhicAmounts(); // Recalculate PHIC Amounts when the PHIC Rate changes
        });

        // Event listener for period dropdown change
        const periodDropdown = document.getElementById('periodDropdown');
        periodDropdown.addEventListener('change', function() {
            const selectedCompanyId = document.getElementById('companyDropdown').value; // Get selected company ID
            const selectedPayrollPeriodId = this.value; // Get selected payroll period ID
            fetchPayrollRecords(selectedCompanyId, selectedPayrollPeriodId); // Fetch payroll records
        });
    </script>
    <style>
        body {
            background-image: url('https://hkpinoytv.com/wp-content/uploads/2024/07/Ombudsman-suspends-3-PhilHealth.png');
            background-size: cover; /* Adjust the background size as needed */
            /* You can add more styling properties here */
        }

        .system-amount {
            text-align: right;
        }

        .employee-id {
            text-align: right;
        }
        
        .basic-pay {
            text-align: right;
        }

        .phic-amount {
            text-align: right;
        }


        .remarks {
            text-align: center;
        }

        .main-header {
            text-align: center;
        }

        .tooltip {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            z-index: 1;
        }

        .remarks:hover .tooltip {
            display: block;
        }
    </style>
    </body>
    </html>